<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“æ³•å…«ä¸Šï¼šé€»è¾‘ä¸è„‰ç»œæ·±åº¦å­¦ä¹ </title>
    <style>
        :root {
            --bg-color: #f1f5f9;
            --surface-color: #ffffff;
            --primary-color: #334155;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0,0,0,0.08);
            --header-bg: rgba(255, 255, 255, 0.95);

            /* é€»è¾‘å±‚çº§é¢œè‰² */
            --level-1: #0ea5e9; /* è“ */
            --level-2: #22c55e; /* ç»¿ */
            --level-3: #f97316; /* æ©™ */
            --level-4: #ef4444; /* çº¢ */

            --pipe-width: 6px;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --primary-color: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-color: rgba(0,0,0,0.3);
            --header-bg: rgba(30, 41, 59, 0.95);

            --level-1: #38bdf8;
            --level-2: #4ade80;
            --level-3: #fb923c;
            --level-4: #f87171;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            background-image:
                    radial-gradient(var(--text-secondary) 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            color: var(--primary-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] body {
            background-image: radial-gradient(rgba(148, 163, 184, 0.2) 1.5px, transparent 1.5px);
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            background: var(--surface-color); border: 1px solid var(--border-color);
            color: var(--primary-color); width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color); font-size: 1.2rem;
        }
        .theme-toggle:hover { transform: scale(1.1); }

        /* ============================
           é¦–é¡µï¼šæç®€å®è§‚åœ°å›¾
           ============================ */
        #macro-map-view {
            flex: 1;
            padding: 2rem 1rem;
            display: flex; /* Flex å¸ƒå±€ç”± CSS æ§åˆ¶ï¼ŒJS åªè´Ÿè´£æ¸…é™¤ inline style */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .map-header {
            text-align: center; margin-bottom: 2rem; position: relative; z-index: 20;
            background: var(--header-bg); backdrop-filter: blur(8px);
            padding: 1.2rem 2.5rem; border-radius: 24px;
            box-shadow: 0 10px 40px var(--shadow-color); border: 1px solid var(--border-color);
        }

        .map-title { font-size: 2rem; font-weight: 900; color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 12px; }
        .map-subtitle { margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.95rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }

        /* Grid å¸ƒå±€ */
        .logic-grid {
            display: grid; grid-template-columns: repeat(12, 1fr);
            column-gap: 1.5rem; row-gap: 5rem;
            max-width: 1100px; width: 100%; padding: 1rem; position: relative;
        }

        /* èŠ‚ç‚¹å¡ç‰‡ */
        .map-node {
            background: var(--surface-color); padding: 2rem 1.5rem; border-radius: 24px;
            position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
            box-shadow: 0 10px 25px -5px var(--shadow-color), 0 4px 10px -2px rgba(0,0,0,0.02);
            border: 4px solid var(--surface-color); z-index: 10;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 180px; text-align: center;
        }
        .map-node:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 25px 50px -12px var(--shadow-color); z-index: 100; border-color: var(--border-color); }

        .node-u1 { grid-row: 4; grid-column: 1 / span 5; border-top: 8px solid var(--level-1); }
        .node-u2 { grid-row: 3; grid-column: 3 / span 5; border-top: 8px solid var(--level-2); }
        .node-u3 { grid-row: 2; grid-column: 5 / span 5; border-top: 8px solid var(--level-3); }
        .node-u4 { grid-row: 1; grid-column: 7 / span 5; border-top: 8px solid var(--level-4); }

        /* é¦–é¡µèƒŒæ™¯å›¾æ ‡ (å¤§å°å·²ä¼˜åŒ–) */
        .node-bg-icon {
            position: absolute; right: -10px; bottom: -20px; width: 100px; height: 100px;
            opacity: 0.08; transform: rotate(-10deg); transition: all 0.5s; z-index: 0; pointer-events: none;
        }
        .node-u1 .node-bg-icon { fill: var(--level-1); }
        .node-u2 .node-bg-icon { fill: var(--level-2); }
        .node-u3 .node-bg-icon { fill: var(--level-3); }
        .node-u4 .node-bg-icon { fill: var(--level-4); }
        .map-node:hover .node-bg-icon { opacity: 0.15; transform: rotate(0) scale(1.1); }

        .node-badge { font-size: 4rem; font-weight: 900; opacity: 0.15; line-height: 0.8; position: absolute; top: 1rem; left: 1.5rem; }
        .node-u1 .node-badge { color: var(--level-1); }
        .node-u2 .node-badge { color: var(--level-2); }
        .node-u3 .node-badge { color: var(--level-3); }
        .node-u4 .node-badge { color: var(--level-4); }

        .node-title { font-size: 1.6rem; font-weight: 800; color: var(--primary-color); position: relative; z-index: 2; margin-top: 1rem;}
        .node-desc { font-size: 0.95rem; color: var(--text-secondary); margin-top: 0.5rem; font-weight: 600; position: relative; z-index: 2; }

        /* Pipes */
        .map-node::after {
            content: ''; position: absolute; z-index: 1; bottom: 100%; left: 50%;
            width: 40%; height: 2.5rem;
            border-left: var(--pipe-width) solid; border-top: var(--pipe-width) solid;
            border-top-left-radius: 24px; display: none;
        }
        .map-node::before {
            content: ''; position: absolute; z-index: 1; bottom: -2.6rem; left: 50%;
            width: var(--pipe-width); height: 2.6rem; background: currentColor; display: none;
        }

        .node-u1::after { display: block; border-color: var(--level-1); animation: pulsePipe 3s infinite; }
        .node-u2::before { display: block; background: var(--level-1); top: auto; bottom: -2.6rem; height: 3rem; }
        .node-u2::after { display: block; border-color: var(--level-2); animation: pulsePipe 3s infinite 0.5s; }
        .node-u3::before { display: block; background: var(--level-2); top: auto; bottom: -2.6rem; height: 3rem; }
        .node-u3::after { display: block; border-color: var(--level-3); animation: pulsePipe 3s infinite 1s; }
        .node-u4::before { display: block; background: var(--level-3); top: auto; bottom: -2.6rem; height: 3rem; }

        .pipe-joint-start, .pipe-joint-end {
            position: absolute; left: calc(50% - 9px); width: 18px; height: 18px;
            border-radius: 50%; background: var(--surface-color); border: 5px solid; z-index: 5;
        }
        .pipe-joint-start { top: -9px; }
        .pipe-joint-end { bottom: -9px; }
        .node-u1 .pipe-joint-start { border-color: var(--level-1); }
        .node-u2 .pipe-joint-start { border-color: var(--level-2); }
        .node-u3 .pipe-joint-start { border-color: var(--level-3); }
        .node-u2 .pipe-joint-end { border-color: var(--level-1); }
        .node-u3 .pipe-joint-end { border-color: var(--level-2); }
        .node-u4 .pipe-joint-end { border-color: var(--level-3); }

        .path-label {
            position: absolute; z-index: 15; background: var(--surface-color); padding: 0.4rem 1rem;
            border-radius: 30px; font-size: 0.8rem; font-weight: 800; color: var(--text-secondary);
            box-shadow: 0 4px 15px var(--shadow-color); border: 2px solid; white-space: nowrap;
            top: -2.5rem; left: 70%; transform: translate(-50%, -50%);
        }
        .label-1 { border-color: var(--level-1); color: var(--level-1); }
        .label-2 { border-color: var(--level-2); color: var(--level-2); }
        .label-3 { border-color: var(--level-3); color: var(--level-3); }

        @keyframes pulsePipe { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }


        /* ============================
           è¯¦æƒ…é¡µï¼šæ¨ªå‘ä¸€ä½“åŒ–çŸ¥è¯†å›¾è°±
           ============================ */
        #unit-detail-view { display: none; min-height: 100vh; background: var(--bg-color); overflow-x: hidden; }

        .unit-header {
            position: sticky; top: 0; z-index: 999; background: var(--header-bg); backdrop-filter: blur(10px);
            padding: 0.8rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .back-btn {
            padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-secondary); font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; font-size: 0.9rem;
        }
        .back-btn:hover { background: var(--bg-color); border-color: var(--text-secondary); }

        .unit-title-group { display: flex; align-items: center; gap: 10px; }
        .unit-title-text { font-size: 1.2rem; font-weight: 800; color: var(--primary-color); }
        .unit-title-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .unit-title-icon svg { width: 24px; height: 24px; }

        .full-graph-container {
            width: 100%; padding: 1.5rem 1rem;
            overflow-x: auto;
            scrollbar-width: thin;
            -ms-overflow-style: -ms-autohiding-scrollbar;
            display: flex; flex-direction: column; justify-content: center; min-height: calc(100vh - 70px);
        }

        .graph-board {
            background: var(--surface-color); border-radius: 30px; box-shadow: 0 25px 50px -12px var(--shadow-color);
            border: 1px solid var(--border-color); position: relative;
            animation: fadeIn 0.5s ease-out;
            min-height: 420px;
            display: inline-block;
            min-width: 100%;
            overflow: hidden;
        }

        .graph-watermark {
            position: absolute; right: -10px; bottom: -20px; width: 180px; height: 180px;
            opacity: 0.05; transform: rotate(-10deg); pointer-events: none; z-index: 0;
        }
        .graph-watermark svg { width: 100%; height: 100%; fill: currentColor; }

        .graph-stage {
            position: relative;
            background: radial-gradient(ellipse at center, var(--surface-color) 40%, var(--bg-color) 100%);
            height: 100%; min-height: 420px; z-index: 1;
        }
        .graph-svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none; }

        .g-node {
            position: absolute; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; z-index: 5; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .g-node:hover { z-index: 20; transform: translate(-50%, -50%) scale(1.1); }

        .g-node-core {
            width: 140px; height: 46px; border-radius: 23px;
            background: var(--surface-color); border: 3px solid;
            box-shadow: 0 8px 16px var(--shadow-color);
            font-weight: 900; font-size: 0.95rem; color: var(--primary-color);
            display: flex; align-items: center; justify-content: center;
        }

        .g-node-know {
            width: 120px; padding: 8px; border-radius: 10px;
            background: var(--bg-color); border: 2px solid var(--text-secondary);
            color: var(--text-secondary); font-weight: 700; font-size: 0.8rem;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .g-node-act {
            width: 120px; padding: 8px; border-radius: 10px;
            background: var(--surface-color); border: 2px solid;
            color: inherit; font-weight: 700; font-size: 0.8rem;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .g-spine-label {
            position: absolute; transform: translate(-50%, -50%);
            background: var(--surface-color); padding: 3px 10px; border-radius: 10px;
            font-size: 0.7rem; font-weight: 700; border: 1px solid;
            z-index: 4; box-shadow: 0 2px 4px var(--shadow-color);
            white-space: nowrap;
        }

        .g-popup {
            position: absolute; top: 105%; width: 240px; background: var(--primary-color);
            padding: 10px; border-radius: 10px; box-shadow: 0 10px 20px var(--shadow-color);
            color: var(--bg-color); opacity: 0; transform: translateY(-5px); transition: all 0.2s;
            text-align: left; font-size: 0.8rem; line-height: 1.5; z-index: 30; pointer-events: none;
        }
        .g-node.active .g-popup, .g-node:hover .g-popup { opacity: 1; transform: translateY(0); }
        .g-popup::before {
            content: ''; position: absolute; top: -6px; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: transparent transparent var(--primary-color) transparent;
        }

        .g-path-core { fill: none; stroke: var(--border-color); stroke-width: 4; stroke-linecap: round; }
        .g-path-sub { fill: none; stroke-width: 2; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            #macro-map-view { display: block; }
            .logic-grid { display: flex; flex-direction: column; gap: 3rem; }
            .map-node { margin: 0 !important; width: 100%; min-height: 160px; }
            .map-node::after { width: 0; height: 3rem; border-top: none; border-left: 4px dashed var(--text-secondary); left: 50%; bottom: 100%; border-radius: 0; }
            .map-node::before { display: none; }
            .path-label { display: none; }
            .pipe-joint-start, .pipe-joint-end { display: none; }

            .full-graph-container { display: block; padding: 1rem; }
            .graph-stage { height: auto !important; padding: 2rem 1rem; }
            .graph-svg { display: none; }
            .g-node { position: relative; transform: none; width: 100%; height: auto; margin-bottom: 1rem; left: auto !important; top: auto !important; }
            .g-node:hover { transform: none; }
            .g-node-core { margin-top: 2rem; margin-bottom: 1rem; width: 100%; background: var(--bg-color); border-color: var(--border-color); color: var(--primary-color); }
            .g-popup { position: static; width: 100%; opacity: 1; transform: none; background: var(--bg-color); color: var(--primary-color); border: 1px dashed var(--border-color); box-shadow: none; margin-top: 8px; }
            .g-popup::before { display: none; }
            .g-spine-label { display: none; }
            .graph-watermark { opacity: 0.03; width: 120px; height: 120px; }
        }
    </style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢æ—¥é—´/å¤œé—´æ¨¡å¼">
    <span id="theme-icon">â˜€ï¸</span>
</button>

<div id="macro-map-view">
    <header class="map-header">
        <h1 class="map-title">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>
            å…«å¹´çº§ä¸Šå†ŒçŸ¥è¯†å…¨æ™¯å›¾
        </h1>
        <div class="map-subtitle">STEP BY STEP Â· å®è§‚è„‰ç»œä¸å¾®è§‚é€»è¾‘</div>
    </header>

    <div class="logic-grid">
        <div class="map-node node-u4" onclick="navigateToUnit(3)">
            <div class="node-badge">04</div>
            <div class="pipe-joint-end"></div>
            <div class="node-title">ç»´æŠ¤å›½å®¶åˆ©ç›Š</div>
            <div class="node-desc">ç»ˆç‚¹ï¼šå›½å®¶å®‰å…¨ä¸å…¬æ°‘ä¹‰åŠ¡</div>
            <svg class="node-bg-icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>

        <div class="map-node node-u3" onclick="navigateToUnit(2)">
            <div class="node-badge">03</div>
            <div class="pipe-joint-end"></div><div class="pipe-joint-start"></div>
            <div class="node-title">å‹‡æ‹…ç¤¾ä¼šè´£ä»»</div>
            <div class="node-desc">å‡åï¼šå…¬å¹³æ­£ä¹‰ä¸è´£ä»»æ‹…å½“</div>
            <div class="path-label label-3">è´£ä»»æ‰©å¤§ â†’ ä¸Šå‡ä¸ºå›½å®¶åˆ©ç›Š</div>
            <svg class="node-bg-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </div>

        <div class="map-node node-u2" onclick="navigateToUnit(1)">
            <div class="node-badge">02</div>
            <div class="pipe-joint-end"></div><div class="pipe-joint-start"></div>
            <div class="node-title">éµå®ˆç¤¾ä¼šè§„åˆ™</div>
            <div class="node-desc">ä¿éšœï¼šè‡ªç”±ä¸è§„åˆ™çš„å¯¹ç«‹ç»Ÿä¸€</div>
            <div class="path-label label-2">ä¸ä»…å®ˆåº•çº¿ â†’ æ›´è¦è®¤åŒä»·å€¼</div>
            <svg class="node-bg-icon" viewBox="0 0 24 24"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
        </div>

        <div class="map-node node-u1" onclick="navigateToUnit(0)">
            <div class="node-badge">01</div>
            <div class="pipe-joint-start"></div>
            <div class="node-title">èµ°è¿›ç¤¾ä¼šç”Ÿæ´»</div>
            <div class="node-desc">èµ·ç‚¹ï¼šæˆ‘æ˜¯ç¤¾ä¼šçš„æœ‰æœºç»„æˆéƒ¨åˆ†</div>
            <div class="path-label label-1">äººæ— æ³•è„±ç¦»ç¤¾ä¼š â†’ å…±å¤„éœ€è¦è§„åˆ™</div>
            <svg class="node-bg-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
    </div>
</div>

<div id="unit-detail-view">
    <header class="unit-header">
        <div class="header-left">
            <button class="back-btn" onclick="navigateHome()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                <span>è¿”å›</span>
            </button>
            <div class="unit-title-group">
                <div class="unit-title-icon" id="detail-header-icon"></div>
                <div class="unit-title-text" id="detail-title">å•å…ƒæ ‡é¢˜</div>
            </div>
        </div>
    </header>

    <div class="full-graph-container">
        <div class="graph-board">
            <div class="graph-watermark" id="detail-watermark"></div>
            <div class="graph-stage" id="full-graph-stage">
                <svg class="graph-svg" id="full-graph-svg"></svg>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.getElementById('theme-icon').innerText = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
        const hash = window.location.hash;
        if(hash.startsWith('#unit=')) {
            const unit = parseInt(hash.split('=')[1]);
            if (!isNaN(unit)) renderUnitView(unit);
        }
    }

    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        toggleTheme();
    }

    const ICONS = {
        u1: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
        u2: '<path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/>',
        u3: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
        u4: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>'
    };

    const courseData = [
        {
            title: "ç¬¬ä¸€å•å…ƒï¼šèµ°è¿›ç¤¾ä¼šç”Ÿæ´»",
            color: "#0ea5e9",
            icon: ICONS.u1,
            steps: [
                {
                    t: "è®¤è¯†ç¤¾ä¼š",
                    connText: "æˆé•¿çš„å¿…ç»ä¹‹è·¯",
                    p: [
                        {type: 'know', tag: "æ˜¯ä»€ä¹ˆ", l:"ç¤¾ä¼šç”Ÿæ´»ç»šä¸½å¤šå½©", c:"å•†åœºè´­ç‰©ã€å‰§é™¢çœ‹æˆã€å…¬å›­æ¸¸ç©...éšç€æˆé•¿ï¼Œæˆ‘ä»¬å¯¹ç¤¾ä¼šçš„æ„Ÿå—è¶Šæ¥è¶Šä¸°å¯Œã€‚"},
                        {type: 'know', tag: "å…³ç³»", l:"ä¸ªäººæ˜¯ç¤¾ä¼šçš„æœ‰æœºç»„æˆéƒ¨åˆ†", c:"ä¸ªäººæ˜¯ç‚¹ï¼Œå…³ç³»æ˜¯çº¿ï¼Œç¤¾ä¼šæ˜¯ç½‘ã€‚æ¯ä¸ªäººéƒ½æ˜¯ç¤¾ä¼šå¤§ç½‘ä¸Šçš„ä¸€ç»“ã€‚"},
                        {type: 'know', tag: "åˆ†ç±»", l:"ä¸»è¦ç¤¾ä¼šå…³ç³»", c:"è¡€ç¼˜å…³ç³»ï¼ˆå®¶åº­ï¼‰ã€åœ°ç¼˜å…³ç³»ï¼ˆé‚»å±…ï¼‰ã€ä¸šç¼˜å…³ç³»ï¼ˆåŒå­¦åŒäº‹ï¼‰ã€‚"}
                    ]
                },
                {
                    t: "èå…¥ç¤¾ä¼š",
                    connText: "é€‚åº”å¤æ‚ç¯å¢ƒ",
                    p: [
                        {type: 'know', tag: "å®šä¹‰", l:"ç¤¾ä¼šåŒ–è¿‡ç¨‹", c:"ä»è‡ªç„¶äººå‘ç¤¾ä¼šäººè½¬å˜ï¼šçŸ¥è¯†ä¸°å¯Œã€èƒ½åŠ›æé«˜ã€è§„åˆ™æ„è¯†å¢å¼ºã€‚"},
                        {type: 'know', tag: "é‡è¦æ€§", l:"äººçš„ç”Ÿå­˜å‘å±•ç¦»ä¸å¼€ç¤¾ä¼š", c:"ç¤¾ä¼šæä¾›ç‰©è´¨æ”¯æŒå’Œç²¾ç¥æ»‹å…»ï¼Œæ˜¯ä¸ªäººæˆé•¿çš„åœŸå£¤ã€‚"},
                        {type: 'know', tag: "ä»·å€¼", l:"äº²ç¤¾ä¼šè¡Œä¸ºçš„é‡è¦æ€§", c:"ä¸ªäººï¼šå…»æˆè‰¯å¥½è¡Œä¸ºä¹ æƒ¯ï¼Œè·å¾—ä»–äººè®¤å¯ã€‚ç¤¾ä¼šï¼šè¥é€ è‰¯å¥½ç¤¾ä¼šé£æ°”ã€‚"},
                        {type: 'act', tag: "è½å®", l:"å…»æˆäº²ç¤¾ä¼šè¡Œä¸º", c:"è¡¨ç°ï¼šè°¦è®©ã€åˆ†äº«ã€å¸®åŠ©ã€åˆä½œã€‚é€”å¾„ï¼šä¸»åŠ¨äº†è§£ç¤¾ä¼šï¼Œç§¯ææŠ•èº«å®è·µã€‚"}
                    ]
                },
                {
                    t: "è§„èŒƒå‚ä¸",
                    connText: null,
                    p: [
                        {type: 'know', tag: "è¾¨æ", l:"ç½‘ç»œæ˜¯æŠŠåŒåˆƒå‰‘", c:"åˆ©ï¼šæ‹“å±•ç©ºé—´ã€ä¾¿åˆ©ç”Ÿæ´»ã€æ¨åŠ¨è¿›æ­¥ã€‚å¼Šï¼šä¿¡æ¯è‰¯è ä¸é½ã€æ²‰è¿·å½±å“ç”Ÿæ´»ã€‚"},
                        {type: 'act', tag: "è¡ŒåŠ¨", l:"ç†æ€§å‚ä¸ç½‘ç»œ", c:"æé«˜åª’ä»‹ç´ å…»ï¼Œå­¦ä¼š'ä¿¡æ¯èŠ‚é£Ÿ'ï¼Œåˆ©ç”¨ç½‘ç»œè·å–æ–°çŸ¥ï¼Œä¸è¢«ä¿¡æ¯æ”¯é…ã€‚"},
                        {type: 'act', tag: "è¡ŒåŠ¨", l:"ä¼ æ’­æ­£èƒ½é‡", c:"è·µè¡Œæ ¸å¿ƒä»·å€¼è§‚ï¼ŒåŸ¹è‚²ç§¯æå¥åº·çš„ç½‘ç»œæ–‡åŒ–ï¼Œå…±åŒè¥é€ æ¸…æœ—ç©ºé—´ã€‚"}
                    ]
                }
            ]
        },
        {
            title: "ç¬¬äºŒå•å…ƒï¼šéµå®ˆç¤¾ä¼šè§„åˆ™",
            color: "#22c55e",
            icon: ICONS.u2,
            steps: [
                {
                    t: "ç¤¾ä¼šéœ€è¦ç§©åº",
                    connText: "ä¿éšœçš„åŸºç¡€",
                    p: [
                        {type: 'know', tag: "å®šä¹‰", l:"ç¤¾ä¼šç§©åºçš„å†…æ¶µ", c:"ç®¡ç†ç§©åºã€ç”Ÿäº§ç§©åºã€äº¤é€šç§©åºã€å…¬å…±åœºæ‰€ç§©åºç­‰æœ‰åºåŒ–çŠ¶æ€ã€‚"},
                        {type: 'know', tag: "ä»·å€¼", l:"ç¤¾ä¼šæ­£å¸¸è¿è¡Œçš„ä¿éšœ", c:"é¿å…æ··ä¹±ï¼Œä¿è¯ç¤¾ä¼šç”Ÿæ´»æœ‰åºè¿›è¡Œã€‚"},
                        {type: 'know', tag: "ä»·å€¼", l:"äººæ°‘å®‰å±…ä¹ä¸šçš„ä¿éšœ", c:"ä¿éšœä¸ªäººç”Ÿå­˜ä¸å‘å±•ï¼Œè®©æˆ‘ä»¬æ„Ÿå—åˆ°å®‰å…¨ä¸å°Šé‡ã€‚"}
                    ]
                },
                {
                    t: "ç§©åºä¾é è§„åˆ™",
                    connText: "å†…åŒ–ä¸å¤–åŒ–",
                    p: [
                        {type: 'know', tag: "å®šä¹‰", l:"ç¤¾ä¼šè§„åˆ™çš„å†…æ¶µ", c:"äººä»¬åœ¨å…±è¯†åŸºç¡€ä¸Šå½¢æˆçš„ã€ç»´æŠ¤ç§©åºçš„è¡Œä¸ºè§„èŒƒã€‚"},
                        {type: 'know', tag: "å…³ç³»", l:"è§„åˆ™ä¸ç§©åºçš„å…³ç³»", c:"è§„åˆ™åˆ’å®šè‡ªç”±è¾¹ç•Œï¼Œä¿éšœç§©åºï¼›ç§©åºæ˜¯è§„åˆ™çš„ç›®çš„ã€‚"},
                        {type: 'know', tag: "åˆ†ç±»", l:"è§„åˆ™çš„ç§ç±»", c:"é“å¾·ï¼ˆè‡ªå¾‹ï¼‰ã€çºªå¾‹ï¼ˆé›†ä½“ï¼‰ã€æ³•å¾‹ï¼ˆä»–å¾‹/å¼ºåˆ¶ï¼‰ã€‚"}
                    ]
                },
                {
                    t: "è‡ªè§‰éµå®ˆè§„åˆ™",
                    connText: null,
                    p: [
                        {type: 'know', tag: "éš¾ç‚¹", l:"è‡ªç”±ä¸è§„åˆ™", c:"è‡ªç”±ä¸æ˜¯éšå¿ƒæ‰€æ¬²ï¼Œå—è§„åˆ™çº¦æŸï¼›éµå®ˆè§„åˆ™æ‰èƒ½äº«æœ‰çœŸæ­£çš„è‡ªç”±ã€‚"},
                        {type: 'act', tag: "è‡ªå¾‹", l:"è‡ªè§‰éµå®ˆç¤¾ä¼šè§„åˆ™", c:"å‘è‡ªå†…å¿ƒæ•¬ç•è§„åˆ™ï¼Œå†…åŒ–äºå¿ƒï¼Œå¤–åŒ–äºè¡Œã€‚"},
                        {type: 'act', tag: "ä»–å¾‹", l:"ç»´æŠ¤ä¸æ”¹è¿›è§„åˆ™", c:"æ•¢äºåŠé˜»è¿è§„è¡Œä¸ºï¼›ç§¯æå»ºè¨€çŒ®ç­–ï¼Œæ¨åŠ¨è§„åˆ™å®Œå–„ã€‚"}
                    ]
                }
            ]
        },
        {
            title: "ç¬¬ä¸‰å•å…ƒï¼šå‹‡æ‹…ç¤¾ä¼šè´£ä»»",
            color: "#f97316",
            icon: ICONS.u3,
            steps: [
                {
                    t: "è®¤åŒä»·å€¼",
                    connText: "ä»·å€¼çš„ä½“ç°",
                    p: [
                        {type: 'know', tag: "æ ¸å¿ƒ", l:"æ³•å¾‹é¢å‰äººäººå¹³ç­‰", c:"åŒç­‰å¯¹å¾…ï¼ˆæœºä¼šã€æƒåˆ©ï¼‰ï¼ŒåŒç­‰ä¿æŠ¤ï¼ˆé€‚ç”¨æ³•å¾‹ï¼‰ã€‚"},
                        {type: 'act', tag: "è¡ŒåŠ¨", l:"çè§†è‡ªç”±", c:"ä¾æ³•è¡Œä½¿æƒåˆ©ï¼Œè‡ªè§‰å±¥è¡Œä¹‰åŠ¡ã€‚"},
                        {type: 'act', tag: "è¡ŒåŠ¨", l:"è·µè¡Œå¹³ç­‰", c:"åå¯¹ç‰¹æƒï¼Œå¹³ç­‰å¯¹å¾…ä»–äººï¼ŒæŠµåˆ¶ä¸å¹³ç­‰è¡Œä¸ºã€‚"}
                    ]
                },
                {
                    t: "åšå®ˆå…¬å¹³æ­£ä¹‰",
                    connText: "ä»ç†å¿µåˆ°è¡ŒåŠ¨",
                    p: [
                        {type: 'know', tag: "å†…æ¶µ", l:"å…¬å¹³ä¸æ­£ä¹‰", c:"å…¬å¹³ï¼šæƒåˆ©/è§„åˆ™/æœºä¼šå…¬å¹³ã€‚æ­£ä¹‰ï¼šç¤¾ä¼šæ–‡æ˜å°ºåº¦ï¼Œç»´æŠ¤å…¬å…±åˆ©ç›Šã€‚"},
                        {type: 'act', tag: "ä¸ªäºº", l:"åšå®ˆå…¬å¹³", c:"ä¸ªäººç»´æŠ¤å…¬å¹³ã€‚é¢å¯¹åˆ©ç›Šå†²çªï¼Œæˆ‘ä»¬è¦ç«™åœ¨å…¬å¹³çš„ç«‹åœºä¸Šï¼Œå­¦ä¼šæ‹…å½“ï¼Œä»¥å…¬å¹³ä¹‹å¿ƒä¸ºäººå¤„ä¸–ã€‚"},
                        {type: 'act', tag: "ä¸ªäºº", l:"å®ˆæŠ¤æ­£ä¹‰", c:"æ•¢äºæ–—äº‰ï¼Œè§ä¹‰å‹‡ä¸ºï¼Œæ›´è¦è§ä¹‰'æ™º'ä¸ºã€‚"},
                        {type: 'act', tag: "å¸æ³•", l:"ç»´æŠ¤æ­£ä¹‰", c:"å…¬æ­£å¸æ³•ï¼Œæå«æ³•å¾‹å°Šä¸¥ï¼Œä¿éšœå…¬æ°‘æƒç›Šã€‚"}
                    ]
                },
                {
                    t: "ä¸»åŠ¨æ‹…å½“è´£ä»»",
                    connText: null,
                    p: [
                        {type: 'know', tag: "å®šä¹‰", l:"ç¤¾ä¼šè´£ä»»", c:"å¯¹å®¶åº­/ç¤¾ä¼š/å›½å®¶åº”æ‰¿æ‹…çš„ä¹‰åŠ¡ä¸æ‹…å½“ã€‚"},
                        {type: 'know', tag: "è¾©è¯", l:"ä»£ä»·ä¸å›æŠ¥", c:"ä»£ä»·ï¼šæ—¶é—´ç²¾åŠ›é‡‘é’±ï¼›å›æŠ¥ï¼šç²¾ç¥æ»¡è¶³ã€èƒ½åŠ›æå‡ã€ç¤¾ä¼šè®¤å¯ã€‚"},
                        {type: 'act', tag: "è¡ŒåŠ¨", l:"åšè´Ÿè´£ä»»çš„äºº", c:"ä¸è¨€ä»£ä»·ä¸å›æŠ¥ã€‚æå‡è‡ªèº«ç´ è´¨ï¼Œä»èº«è¾¹å°äº‹åšèµ·ã€‚"}
                    ]
                }
            ]
        },
        {
            title: "ç¬¬å››å•å…ƒï¼šç»´æŠ¤å›½å®¶åˆ©ç›Š",
            color: "#ef4444",
            icon: ICONS.u4,
            steps: [
                {
                    t: "å›½å®¶åˆ©ç›Šè‡³ä¸Š",
                    connText: "åˆ©ç›Šçš„åº•çº¿",
                    p: [
                        {type: 'know', tag: "å®šä¹‰", l:"å›½å®¶åˆ©ç›Šçš„å†…æ¶µ", c:"ä¸»æƒå›½å®¶ç”Ÿå­˜ä¸å‘å±•çš„éœ€æ±‚æ€»å’Œï¼ˆä¸»æƒã€å®‰å…¨ã€å‘å±•åˆ©ç›Šï¼‰ã€‚"},
                        {type: 'know', tag: "å…³ç³»", l:"åˆ©ç›Šä¸€è‡´æ€§", c:"å›½å®¶åˆ©ç›Šä¸ä¸ªäººåˆ©ç›Šæ ¹æœ¬ä¸€è‡´ã€‚å›½å®¶å¥½ï¼Œå¤§å®¶æ‰å¥½ã€‚"},
                        {type: 'act', tag: "å†²çª", l:"åšæŒå›½å®¶åˆ©ç›Šè‡³ä¸Š", c:"å½“å‘ç”Ÿå†²çªæ—¶ï¼Œä¸ªäººåˆ©ç›Šå¿…é¡»æœä»å›½å®¶åˆ©ç›Šã€‚"}
                    ]
                },
                {
                    t: "å›½å®¶å®‰å…¨ä¿éšœ",
                    connText: "å…¬æ°‘çš„ä¹‰åŠ¡",
                    p: [
                        {type: 'know', tag: "ä½“ç³»", l:"æ€»ä½“å›½å®¶å®‰å…¨è§‚", c:"ä»¥äººæ°‘å®‰å…¨ä¸ºå®—æ—¨ï¼Œæ”¿æ²»å®‰å…¨ä¸ºæ ¹æœ¬ï¼Œç»æµå®‰å…¨ä¸ºåŸºç¡€ã€‚"},
                        {type: 'know', tag: "ä»·å€¼", l:"å›½å®¶å®‰å…¨çš„é‡è¦æ€§", c:"å›½å®¶ç”Ÿå­˜ä¸å‘å±•çš„é‡è¦ä¿éšœï¼Œäººæ°‘å¹¸ç¦å®‰åº·çš„å‰æã€‚"},
                        {type: 'act', tag: "å¼ºå†›", l:"å›½é˜²ä¸å†›é˜Ÿç°ä»£åŒ–", c:"å»ºè®¾å¬å…šæŒ‡æŒ¥ã€èƒ½æ‰“èƒœä»—ã€ä½œé£ä¼˜è‰¯çš„äººæ°‘å†›é˜Ÿã€‚"}
                    ]
                },
                {
                    t: "å±¥è¡Œå…¬æ°‘è´£ä»»",
                    connText: null,
                    p: [
                        {type: 'act', tag: "æ„è¯†", l:"å¢å¼ºå®‰å…¨æ„è¯†", c:"æ ‘ç«‹å±æœºæ„è¯†ï¼Œä¸ä¿¡è°£ä¸ä¼ è°£ï¼Œéµå®ˆä¿å¯†è§„å®šã€‚"},
                        {type: 'act', tag: "è¡ŒåŠ¨", l:"æå«å›½å®¶åˆ©ç›Š", c:"é…åˆå®‰å…¨æœºå…³å·¥ä½œï¼ŒåŒæŸå®³å›½å®¶åˆ©ç›Šçš„è¡Œä¸ºä½œæ–—äº‰ã€‚"}
                    ]
                }
            ]
        }
    ];

    const mapEl = document.getElementById('macro-map-view');
    const unitEl = document.getElementById('unit-detail-view');
    const detailTitle = document.getElementById('detail-title');
    const graphStage = document.getElementById('full-graph-stage');
    const graphSvg = document.getElementById('full-graph-svg');
    const headerIconEl = document.getElementById('detail-header-icon');
    const watermarkEl = document.getElementById('detail-watermark');

    function navigateToUnit(idx) {
        window.location.hash = 'unit=' + idx;
    }

    function navigateHome() {
        window.location.hash = '';
    }

    function router() {
        const hash = window.location.hash;
        if (hash.startsWith('#unit=')) {
            const unitIdx = parseInt(hash.split('=')[1]);
            if (!isNaN(unitIdx) && courseData[unitIdx]) {
                renderUnitView(unitIdx);
                return;
            }
        }
        renderHomeView();
    }

    window.addEventListener('hashchange', router);
    // Use DOMContentLoaded to ensure initial render
    document.addEventListener('DOMContentLoaded', router);

    function renderHomeView() {
        // Clear inline display style to let CSS media queries take over
        mapEl.style.display = '';
        unitEl.style.display = 'none';
        window.scrollTo(0, 0);
    }

    function renderUnitView(idx) {
        const d = courseData[idx];
        document.documentElement.style.setProperty('--accent-color', d.color);
        detailTitle.innerText = d.title;

        headerIconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="${d.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${d.icon}</svg>`;
        watermarkEl.innerHTML = `<svg viewBox="0 0 24 24" fill="${d.color}">${d.icon}</svg>`;

        renderHorizontalGraph(d.steps, d.color);

        mapEl.style.display = 'none';
        unitEl.style.display = 'block';
        window.scrollTo(0,0);
    }

    function renderHorizontalGraph(steps, color) {
        graphStage.innerHTML = '';
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute('class', 'graph-svg');
        graphStage.appendChild(svg);

        const stepWidth = 380;
        const stagePadding = 100;
        const totalWidth = steps.length * stepWidth + stagePadding * 2;
        graphStage.style.width = totalWidth + 'px';
        graphStage.style.height = '420px';

        const spineY = 210;
        drawHorizontalSpine(svg, stagePadding, totalWidth - stagePadding, spineY);

        steps.forEach((step, i) => {
            const centerX = stagePadding + i * stepWidth + stepWidth / 2;

            createNode(graphStage, step.t, 'core', centerX, spineY, null, color);

            if (i < steps.length - 1) {
                const nextX = stagePadding + (i + 1) * stepWidth + stepWidth / 2;
                const midX = (centerX + nextX) / 2;
                if (step.connText) {
                    const label = document.createElement('div');
                    label.className = 'g-spine-label';
                    label.innerText = step.connText;
                    label.style.left = midX + 'px';
                    label.style.top = spineY + 'px';
                    label.style.borderColor = color;
                    label.style.color = color;
                    graphStage.appendChild(label);
                }
            }

            const knowPoints = step.p.filter(p => p.type === 'know');
            distributeNodes(knowPoints, 'know', centerX, spineY, -1, graphStage, svg, color);

            const actPoints = step.p.filter(p => p.type === 'act');
            distributeNodes(actPoints, 'act', centerX, spineY, 1, graphStage, svg, color);
        });
    }

    function distributeNodes(points, type, centerX, centerY, direction, stage, svg, color) {
        const verticalBase = 70;
        const horizontalStep = 110;

        points.forEach((p, idx) => {
            const totalWidth = (points.length - 1) * horizontalStep;
            const startX = centerX - totalWidth / 2;
            const nodeX = startX + idx * horizontalStep;
            const nodeY = centerY + direction * (verticalBase + (idx % 2) * 30);

            createNode(stage, p.l, type, nodeX, nodeY, p, color);

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const knowColor = isDark ? '#94a3b8' : '#94a3b8';

            const lineColor = type === 'know' ? knowColor : color;
            const lineStyle = type === 'know' ? 'dashed' : 'solid';

            drawCurve(svg, centerX, centerY, nodeX, nodeY, lineColor, lineStyle, direction);
        });
    }

    function createNode(parent, text, type, x, y, data, color) {
        const div = document.createElement('div');
        div.className = `g-node g-node-${type}`;
        div.style.left = x + 'px';
        div.style.top = y + 'px';
        div.innerHTML = text;

        if(type === 'core') {
            div.style.borderColor = color;
            div.style.color = color;
        } else if (type === 'act') {
            div.style.borderColor = color;
            div.style.color = color;
        }

        if (data) {
            const popup = document.createElement('div');
            popup.className = 'g-popup';
            popup.innerHTML = `<strong>ã€${data.tag}ã€‘</strong><br>${data.c}`;
            if(type === 'know') {
                popup.style.bottom = '110%';
                popup.style.top = 'auto';
                popup.style.transform = 'translateY(10px)';
            }
            div.appendChild(popup);
        }
        parent.appendChild(div);
    }

    function drawHorizontalSpine(svg, x1, x2, y) {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x1);
        line.setAttribute("y1", y);
        line.setAttribute("x2", x2);
        line.setAttribute("y2", y);

        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const color = isDark ? '#475569' : '#cbd5e1';

        line.setAttribute("stroke", color);
        line.setAttribute("stroke-width", "4");
        line.setAttribute("stroke-linecap", "round");
        svg.appendChild(line);
    }

    function drawCurve(svg, x1, y1, x2, y2, color, style, direction) {
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const c1x = x1, c1y = y1 + direction * 40;
        const c2x = x2, c2y = y2 - direction * 40;
        const d = `M${x1},${y1} C${c1x},${c1y} ${c2x},${c2y} ${x2},${y2}`;
        path.setAttribute("d", d);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", color);
        path.setAttribute("stroke-width", "2");
        if(style === 'dashed') path.setAttribute("stroke-dasharray", "4,4");
        svg.appendChild(path);
    }
</script>
</body>
</html>